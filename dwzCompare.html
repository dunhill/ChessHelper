<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schachbund Multi-Spieler DWZ Chart</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f7f7f7;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    input,
    button {
      display: block;
      margin-top: 10px;
      width: 100%;
      font-size: 1rem;
      padding: 8px;
    }

    button {
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #005fa3;
    }

    .player-section {
      margin-top: 40px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 6px 10px;
      text-align: left;
    }

    th {
      background-color: #0077cc;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #chartContainer {
      margin-top: 50px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <h1>DWZ-Verlauf mehrerer Spieler</h1>
  <label for="pkz">Spieler-IDs (kommagetrennt):</label>
  <input type="text" id="pkz" placeholder="z. B. 12345,67890">
  <button id="fetchBtn">Daten abrufen</button>

  <div id="playersContainer"></div>

  <div id="chartContainer">
    <canvas id="dwzChart" width="800" height="400"></canvas>
  </div>

  <!-- Chart.js + Luxon for time axis -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>

  <script>
    const chartColors = [
      '#0077cc', '#ff5733', '#28a745', '#9b59b6',
      '#ff9800', '#00bcd4', '#e91e63', '#795548'
    ];

    async function fetchTournamentDate(tournamentCode) {
      const url = `https://www.schachbund.de/turnier/${tournamentCode}.html`;
      try {
        const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const row = doc.querySelector('.row_3');
        if (!row) return null;
        const cell = row.querySelector('.col_2.value.bottom-line');
        return cell ? cell.textContent.trim() : null;
      } catch (err) {
        console.error('Fehler Turnierdatum:', err);
        return null;
      }
    }

    function parseDateString(dateStr) {
      const parts = dateStr.split('.');
      if (parts.length !== 3) return null;
      const [day, month, year] = parts.map(x => parseInt(x, 10));
      return new Date(year, month - 1, day);
    }

    async function fetchPlayerData(pkz, color) {
      const targetUrl = `https://www.schachbund.de/php/dewis/spieler.php?pkz=${encodeURIComponent(pkz)}&format=csv`;
      const corsUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
  const playerSection = document.createElement('div');
  playerSection.className = 'player-section';
  const loadingH2 = document.createElement('h2');
  loadingH2.textContent = `Spieler ${pkz}`;
  const loadingP = document.createElement('p');
  loadingP.textContent = 'Lade Daten...';
  playerSection.appendChild(loadingH2);
  playerSection.appendChild(loadingP);
      document.getElementById('playersContainer').appendChild(playerSection);

      try {
        const response = await fetch(corsUrl);
        if (!response.ok) throw new Error(`HTTP-Fehler: ${response.status}`);
        const csv = await response.text();
        const rows = csv.trim().split('\n').map(r => r.split('|'));

        // ✅ Get player's name from second row, third column
        const playerName = rows[1]?.[2]?.trim() || `Spieler ${pkz}`;

        // ✅ Dynamically find header row by "turniercode"
        const headerIndex = rows.findIndex(
          r => r[0] && r[0].trim().toLowerCase() === 'turniercode'
        );
        if (headerIndex === -1) {
          playerSection.innerHTML = '';
          const h = document.createElement('h2');
          h.textContent = playerName;
          const p = document.createElement('p');
          p.style.color = 'red';
          p.textContent = 'Keine Kopfzeile ("turniercode") gefunden.';
          playerSection.appendChild(h);
          playerSection.appendChild(p);
          return null;
        }

  const headers = rows[headerIndex] || [];
  const dataRows = rows.slice(headerIndex + 1); // keep all data rows

        if (dataRows.length === 0) {
          playerSection.innerHTML = '';
          const h = document.createElement('h2');
          h.textContent = playerName;
          const p = document.createElement('p');
          p.textContent = 'Keine Datenzeilen gefunden.';
          playerSection.appendChild(h);
          playerSection.appendChild(p);
          return null;
        }

        // ✅ Case-insensitive match for DWZneu column
        const dwzIndex = headers.findIndex(h => h.trim().toLowerCase() === 'dwzneu');

        // ✅ Collect tournament codes
        const tournaments = dataRows.map(r => r[0]?.trim()).filter(Boolean);

        // ✅ Fetch tournament dates in parallel
        const dateResults = await Promise.allSettled(
          tournaments.map(code => fetchTournamentDate(code))
        );

        // ✅ Build table
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = (h || '').trim();
          headerRow.appendChild(th);
        });
        const thDate = document.createElement('th');
        thDate.textContent = 'Turnierdatum';
        headerRow.appendChild(thDate);
        thead.appendChild(headerRow);

        const chartPoints = [];

        // Build list of tournament codes with their original dataRows index so
        // the dateResults can be mapped back to the correct row even if some
        // codes are missing/empty.
        const tournamentsWithIndex = dataRows
          .map((r, idx) => ({ code: (r && r[0]) ? r[0].trim() : '', idx }))
          .filter(t => t.code);

        // Map settled results back to original row indices
        const dateMap = {};
        dateResults.forEach((res, i) => {
          const info = tournamentsWithIndex[i];
          if (!info) return;
          dateMap[info.idx] = res.status === 'fulfilled' ? res.value : null;
        });

        dataRows.forEach((row, i) => {
          const tr = document.createElement('tr');
          (row || []).forEach(cell => {
            const td = document.createElement('td');
            td.textContent = (cell || '').trim();
            tr.appendChild(td);
          });

          const dateStr = dateMap[i] || null;
          const dateTd = document.createElement('td');
          dateTd.textContent = dateStr || 'Unbekannt';
          tr.appendChild(dateTd);
          tbody.appendChild(tr);

          const dwzValue = dwzIndex >= 0 && (row && row[dwzIndex]) ? parseInt((row[dwzIndex] || '').trim(), 10) : NaN;
          const dateObj = parseDateString(dateStr || '');
          if (dateObj instanceof Date && !isNaN(dateObj) && !isNaN(dwzValue)) {
            chartPoints.push({ x: dateObj, y: dwzValue });
          }
        });

        table.appendChild(thead);
        table.appendChild(tbody);
  // Avoid inserting untrusted HTML into innerHTML; use textContent instead
  playerSection.innerHTML = '';
  const h2 = document.createElement('h2');
  h2.textContent = playerName;
  playerSection.appendChild(h2);
  playerSection.appendChild(table);

        chartPoints.sort((a, b) => a.x - b.x);

        console.log(`✅ ${playerName}: ${chartPoints.length} Punkte`, chartPoints);

        return { pkz, playerName, data: chartPoints, color };

      } catch (err) {
        playerSection.innerHTML = '';
        const h = document.createElement('h2');
        h.textContent = `Spieler ${pkz}`;
        const p = document.createElement('p');
        p.style.color = 'red';
        p.textContent = `Fehler: ${err.message}`;
        playerSection.appendChild(h);
        playerSection.appendChild(p);
        console.error(err);
        return null;
      }
    }

    document.getElementById('fetchBtn').addEventListener('click', async () => {
      const input = document.getElementById('pkz').value.trim();
      const ids = input.split(',').map(x => x.trim()).filter(Boolean);
      const container = document.getElementById('playersContainer');
      container.innerHTML = '';
      const chartCanvas = document.getElementById('dwzChart');
      if (chartCanvas.chart) chartCanvas.chart.destroy();

      if (ids.length === 0) {
        container.innerHTML = '<p style="color:red;">Bitte mindestens eine Spieler-ID angeben.</p>';
        return;
      }

      const datasets = [];
      for (let i = 0; i < ids.length; i++) {
        const color = chartColors[i % chartColors.length];
        const playerData = await fetchPlayerData(ids[i], color);
        if (playerData && playerData.data.length > 0) {
          datasets.push({
            label: playerData.playerName,
            data: playerData.data,
            borderColor: playerData.color,
            backgroundColor: playerData.color + '33',
            fill: false,
            tension: 0.3
          });
        }
      }

      if (datasets.length === 0) return;

      chartCanvas.chart = new Chart(chartCanvas, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, position: 'bottom' }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day', tooltipFormat: 'dd.MM.yyyy' },
              title: { display: true, text: 'Turnierdatum' }
            },
            y: {
              title: { display: true, text: 'DWZneu' },
              beginAtZero: false
            }
          }
        }
      });
    });
  </script>
</body>

</html>